---

machine:
  environment:
    PYTHON_BUILD_VERSION: 2.7.10
    PYTHON_BUILD_PATH: $HOME/Python-$PYTHON_BUILD_VERSION
    PYTHON_EXEC_PATH: $PYTHON_BUILD_PATH/bin
    PYTHON_TARBALL: Python-$PYTHON_BUILD_VERSION.tar.xz
    VTK_BUILD_VERSION: 5.10.1
    VTK_BUILD_PREFIX: ${VTK_BUILD_VERSION::-2}
    VTK_BUILD_PATH: $HOME/VTK$VTK_BUILD_VERSION
    VTK_TARBALL: vtk-$VTK_BUILD_VERSION.tar.gz

dependencies:
  pre:
    - cd ~ && wget http://www.vtk.org/files/release/$VTK_BUILD_PREFIX/$VTK_TARBALL
    - cd ~ && tar -xvf $VTK_TARBALL
    - cd $VTK_BUILD_PATH && cmake -D VTK_WRAP_PYTHON:BOOL=ON -D BUILD_SHARED_LIBS:BOOL=ON ./
    - cd $VTK_BUILD_PATH && make all

    - cd ~ && wget https://www.python.org/ftp/python/$PYTHON_BUILD_VERSION/$PYTHON_TARBALL
    - cd ~ && tar -xvf $PYTHON_TARBALL
    - cd $PYTHON_BUILD_PATH && ./configure --enable-unicode=ucs4 --prefix=$PYTHON_BUILD_PATH --with-ensurepip="upgrade"
    - cd $PYTHON_BUILD_PATH && make
    - cd $PYTHON_BUILD_PATH && make install

  post:
    - $PYTHON_EXEC_PATH/pip install -r requirements.txt

  cache_directories:
    - $PYTHON_BUILD_PATH
    - $VTK_BUILD_PATH

test:
  override:
    - $PYTHON_EXEC_PATH/python -m pytest ~/chagu/test/:
        environment:
          LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$VTK_BUILD_PATH/bin"
          PYTHONPATH: "$PYTHONPATH:$HOME/chagu:$VTK_BUILD_PATH/Wrapping/Python:$VTK_BUILD_PATH/bin"